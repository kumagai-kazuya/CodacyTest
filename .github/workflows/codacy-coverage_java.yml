name: Java Codacy Analysis and Coverage

on:
  push:
    branches:
      # - main
      - codacytest
  pull_request:

jobs:
  codacy-analysis:
    runs-on: ubuntu-latest

    steps:
      # 1. リポジトリをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 全履歴を取得する

      # 2. JDKのセットアップ
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version:  17 
          distribution:  temurin 

      # 3. Codacy Analysis CLIのダウンロード
      - name: Download Codacy Analysis CLI
        run: |
          wget https://github.com/codacy/codacy-analysis-cli/releases/latest/download/codacy-analysis-cli-linux
          chmod +x codacy-analysis-cli-linux

      # 4. Codacy Analysis CLIを実行
      - name: Run Codacy Analysis CLI
        env:
          CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}
        run: |
          ./codacy-analysis-cli-linux analyze --project-token $CODACY_PROJECT_TOKEN \
            --commit-uuid ${{ github.sha }}

      # 5. JaCoCoのカバレッジレポートを生成
      - name: Build and test with Maven
        run: mvn clean verify

      # 6. カバレッジレポートをCodacyにアップロード
      - name: Upload coverage to Codacy
        uses: codacy/codacy-coverage-reporter-action@v1
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: target/site/jacoco/jacoco.xml